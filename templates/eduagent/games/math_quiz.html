{% extends 'base.html' %}

{% block title %}{{ game.title }} - Falak{% endblock %}

{% block extra_css %}
<style>
.game-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.question-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 30px;
    color: white;
    text-align: center;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.question-text {
    font-size: 36px;
    font-weight: bold;
    margin-bottom: 20px;
}

.answer-input {
    width: 100%;
    padding: 15px;
    font-size: 24px;
    border: none;
    border-radius: 10px;
    text-align: center;
    margin: 20px 0;
}

.game-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 30px;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.stat-number {
    font-size: 24px;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.game-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.btn-game {
    padding: 15px 30px;
    font-size: 18px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-check {
    background: #28a745;
    color: white;
}

.btn-check:hover {
    background: #218838;
    transform: translateY(-2px);
}

.btn-skip {
    background: #6c757d;
    color: white;
}

.btn-skip:hover {
    background: #5a6268;
    transform: translateY(-2px);
}

.result-message {
    padding: 15px;
    border-radius: 10px;
    margin: 20px 0;
    font-weight: bold;
    text-align: center;
}

.result-correct {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.result-wrong {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 20px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    transition: width 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="game-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã -->
        <div class="text-center mb-4">
            <h2><i class="fas fa-calculator me-2"></i>{{ game.title }}</h2>
            <p class="text-muted">{{ game.description }}</p>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã -->
        <div class="game-stats">
            <div class="stat-item">
                <div class="stat-number" id="score">0</div>
                <div class="stat-label">–û—á–∫–∏</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="timer">0:00</div>
                <div class="stat-label">–í—Ä–µ–º—è</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="coins">{{ user_coins }}</div>
                <div class="stat-label">–ú–æ–Ω–µ—Ç—ã</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="question-number">1/10</div>
                <div class="stat-label">–í–æ–ø—Ä–æ—Å</div>
            </div>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
        <div class="progress-bar">
            <div class="progress-fill" id="progress" style="width: 10%"></div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ -->
        <div class="question-card">
            <div class="question-text" id="question">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <input type="number" class="answer-input" id="answer" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç" autocomplete="off">
            <div id="result-message"></div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="game-controls">
            <button class="btn-game btn-check" onclick="checkAnswer()">
                <i class="fas fa-check me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å
            </button>
            <button class="btn-game btn-skip" onclick="skipQuestion()">
                <i class="fas fa-forward me-2"></i>–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
            </button>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã -->
        <div id="game-results" style="display: none;">
            <div class="text-center">
                <h3>üéâ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h3>
                <div class="mt-4">
                    <h4>–¢–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h4>
                    <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <strong id="correct-count">0</strong></p>
                    <p>–í—Ä–µ–º—è –∏–≥—Ä—ã: <strong id="total-time">0:00</strong></p>
                    <p>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –º–æ–Ω–µ—Ç: <strong id="earned-coins">0</strong></p>
                    <p>–û–±—â–∏–π —Å—á–µ—Ç: <strong id="final-score">0</strong></p>
                </div>
                <div class="mt-4">
                    <a href="{% url 'mini_games' %}" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>–ù–∞–∑–∞–¥ –∫ –∏–≥—Ä–∞–º
                    </a>
                    <button class="btn btn-success" onclick="restartGame()">
                        <i class="fas fa-redo me-2"></i>–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentQuestion = 0;
let score = 0;
let correctAnswers = 0;
let startTime = Date.now();
let timerInterval;
let questions = [];

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
function generateQuestions() {
    questions = [];
    const operations = ['+', '-', '*', '/'];
    
    for (let i = 0; i < 10; i++) {
        const operation = operations[Math.floor(Math.random() * operations.length)];
        let a, b, answer, question;
        
        switch(operation) {
            case '+':
                a = Math.floor(Math.random() * 50) + 1;
                b = Math.floor(Math.random() * 50) + 1;
                answer = a + b;
                question = `${a} + ${b} = ?`;
                break;
            case '-':
                a = Math.floor(Math.random() * 50) + 10;
                b = Math.floor(Math.random() * a) + 1;
                answer = a - b;
                question = `${a} - ${b} = ?`;
                break;
            case '*':
                a = Math.floor(Math.random() * 12) + 1;
                b = Math.floor(Math.random() * 12) + 1;
                answer = a * b;
                question = `${a} √ó ${b} = ?`;
                break;
            case '/':
                b = Math.floor(Math.random() * 10) + 1;
                answer = Math.floor(Math.random() * 10) + 1;
                a = b * answer;
                question = `${a} √∑ ${b} = ?`;
                break;
        }
        
        questions.push({
            question: question,
            answer: answer.toString()
        });
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å
function showQuestion() {
    if (currentQuestion >= questions.length) {
        endGame();
        return;
    }
    
    const question = questions[currentQuestion];
    document.getElementById('question').textContent = question.question;
    document.getElementById('answer').value = '';
    document.getElementById('answer').focus();
    document.getElementById('question-number').textContent = `${currentQuestion + 1}/${questions.length}`;
    document.getElementById('progress').style.width = `${((currentQuestion + 1) / questions.length) * 100}%`;
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    const resultDiv = document.getElementById('result-message');
    resultDiv.className = '';
    resultDiv.textContent = '';
}

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
function checkAnswer() {
    const userAnswer = document.getElementById('answer').value.trim();
    const correctAnswer = questions[currentQuestion].answer;
    const resultDiv = document.getElementById('result-message');
    
    if (!userAnswer) {
        resultDiv.className = 'result-message result-wrong';
        resultDiv.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç!';
        return;
    }
    
    if (userAnswer === correctAnswer) {
        // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        correctAnswers++;
        score += 10;
        resultDiv.className = 'result-message result-correct';
        resultDiv.textContent = '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
        document.getElementById('score').textContent = score;
        
        setTimeout(() => {
            currentQuestion++;
            showQuestion();
        }, 1000);
    } else {
        // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        resultDiv.className = 'result-message result-wrong';
        resultDiv.textContent = `‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${correctAnswer}`;
        
        setTimeout(() => {
            currentQuestion++;
            showQuestion();
        }, 2000);
    }
}

// –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–æ–ø—Ä–æ—Å
function skipQuestion() {
    currentQuestion++;
    showQuestion();
}

// –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä
function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

// –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É
function endGame() {
    clearInterval(timerInterval);
    
    const totalTime = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(totalTime / 60);
    const seconds = totalTime % 60;
    const earnedCoins = Math.floor(correctAnswers * {{ game.reward_coins }} / 10);
    
    document.getElementById('correct-count').textContent = correctAnswers;
    document.getElementById('total-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('earned-coins').textContent = earnedCoins;
    document.getElementById('final-score').textContent = score;
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–≥—Ä—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    document.querySelector('.question-card').style.display = 'none';
    document.querySelector('.game-controls').style.display = 'none';
    document.getElementById('game-results').style.display = 'block';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch(`/games/play/{{ game.id }}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `score=${score}&time_spent=${totalTime}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('earned-coins').textContent = data.coins_earned;
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', data);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', error);
    });
}

// –ù–∞—á–∞—Ç—å –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ
function restartGame() {
    currentQuestion = 0;
    score = 0;
    correctAnswers = 0;
    startTime = Date.now();
    
    document.getElementById('score').textContent = '0';
    document.querySelector('.question-card').style.display = 'block';
    document.querySelector('.game-controls').style.display = 'flex';
    document.getElementById('game-results').style.display = 'none';
    
    generateQuestions();
    showQuestion();
    startTimer();
}

// –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä
function startTimer() {
    clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 1000);
}

// –ü–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
document.addEventListener('DOMContentLoaded', function() {
    generateQuestions();
    showQuestion();
    startTimer();
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter
    document.getElementById('answer').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            checkAnswer();
        }
    });
});
</script>
{% endblock %}
