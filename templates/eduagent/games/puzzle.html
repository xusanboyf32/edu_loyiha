{% extends 'base.html' %}

{% block title %}{{ game.title }} - Falak{% endblock %}

{% block extra_css %}
<style>
.game-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.game-board {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.puzzle-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 5px;
    width: 300px;
    height: 300px;
    margin: 20px auto;
    background: #333;
    padding: 5px;
    border-radius: 10px;
}

.puzzle-piece {
    background: white;
    border: 2px solid #ddd;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
}

.puzzle-piece:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.puzzle-piece.empty {
    background: #333;
    border: 2px solid #333;
    cursor: default;
}

.puzzle-piece.empty:hover {
    transform: none;
    box-shadow: none;
}

.game-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 30px;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.stat-number {
    font-size: 24px;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.game-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.btn-game {
    padding: 15px 30px;
    font-size: 18px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-start {
    background: #28a745;
    color: white;
}

.btn-shuffle {
    background: #ffc107;
    color: #333;
}

.message {
    padding: 15px;
    border-radius: 10px;
    margin: 20px 0;
    font-weight: bold;
    text-align: center;
}

.message-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.message-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.preview-image {
    width: 150px;
    height: 150px;
    margin: 20px auto;
    border: 3px solid #fff;
    border-radius: 10px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
    padding: 2px;
    background: #333;
}

.preview-piece {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    border-radius: 3px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="game-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã -->
        <div class="text-center mb-4">
            <h2><i class="fas fa-puzzle-piece me-2"></i>{{ game.title }}</h2>
            <p class="text-muted">{{ game.description }}</p>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã -->
        <div class="game-stats">
            <div class="stat-item">
                <div class="stat-number" id="moves">0</div>
                <div class="stat-label">–•–æ–¥–æ–≤</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="timer">0:00</div>
                <div class="stat-label">–í—Ä–µ–º—è</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="coins">{{ user_coins }}</div>
                <div class="stat-label">–ú–æ–Ω–µ—Ç—ã</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="progress">0%</div>
                <div class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
            </div>
        </div>

        <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
        <div class="game-board">
            <div class="text-center">
                <h4>–°–æ–±–µ—Ä–∏ –ø–∞–∑–ª:</h4>
                
                <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
                <div class="preview-image" id="preview">
                    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                
                <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
                <div class="puzzle-container" id="puzzle-container">
                    <!-- –ü–∞–∑–ª –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                
                <div id="message"></div>
                
                <div class="game-controls">
                    <button class="btn-game btn-start" id="start-btn" onclick="startGame()">
                        <i class="fas fa-play me-2"></i>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É
                    </button>
                    <button class="btn-game btn-shuffle" id="shuffle-btn" onclick="shufflePuzzle()" style="display: none;">
                        <i class="fas fa-random me-2"></i>–ü–µ—Ä–µ–º–µ—à–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let puzzle = [];
let emptyPosition = 8;
let moves = 0;
let startTime = Date.now();
let timerInterval;
let gameActive = false;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–∑–ª–∞
function initPuzzle() {
    puzzle = [1, 2, 3, 4, 5, 6, 7, 8, 0];
    emptyPosition = 8;
    renderPuzzle();
    renderPreview();
}

// –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø–∞–∑–ª
function renderPuzzle() {
    const container = document.getElementById('puzzle-container');
    container.innerHTML = '';
    
    puzzle.forEach((value, index) => {
        const piece = document.createElement('div');
        piece.className = 'puzzle-piece';
        
        if (value === 0) {
            piece.classList.add('empty');
        } else {
            piece.textContent = value;
            piece.onclick = () => movePiece(index);
        }
        
        container.appendChild(piece);
    });
}

// –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
function renderPreview() {
    const preview = document.getElementById('preview');
    preview.innerHTML = '';
    
    for (let i = 1; i <= 9; i++) {
        const piece = document.createElement('div');
        piece.className = 'preview-piece';
        
        if (i < 9) {
            piece.textContent = i;
        } else {
            piece.style.background = '#333';
        }
        
        preview.appendChild(piece);
    }
}

// –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
function startGame() {
    gameActive = true;
    moves = 0;
    startTime = Date.now();
    
    document.getElementById('moves').textContent = '0';
    document.getElementById('start-btn').style.display = 'none';
    document.getElementById('shuffle-btn').style.display = 'inline-block';
    document.getElementById('message').innerHTML = '';
    
    shufflePuzzle();
    startTimer();
}

// –ü–µ—Ä–µ–º–µ—à–∞—Ç—å –ø–∞–∑–ª
function shufflePuzzle() {
    // –î–µ–ª–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Ö–æ–¥—ã –¥–ª—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è
    for (let i = 0; i < 100; i++) {
        const possibleMoves = getPossibleMoves();
        const randomMove = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
        swapPieces(randomMove, emptyPosition);
        emptyPosition = randomMove;
    }
    
    moves = 0;
    document.getElementById('moves').textContent = '0';
    renderPuzzle();
    updateProgress();
}

// –ü–æ–ª—É—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ö–æ–¥—ã
function getPossibleMoves() {
    const moves = [];
    const row = Math.floor(emptyPosition / 3);
    const col = emptyPosition % 3;
    
    // –í–≤–µ—Ä—Ö
    if (row > 0) moves.push(emptyPosition - 3);
    // –í–Ω–∏–∑
    if (row < 2) moves.push(emptyPosition + 3);
    // –í–ª–µ–≤–æ
    if (col > 0) moves.push(emptyPosition - 1);
    // –í–ø—Ä–∞–≤–æ
    if (col < 2) moves.push(emptyPosition + 1);
    
    return moves;
}

// –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–∏–≥—É—Ä—É
function movePiece(position) {
    if (!gameActive) return;
    
    const possibleMoves = getPossibleMoves();
    
    if (possibleMoves.includes(position)) {
        swapPieces(position, emptyPosition);
        emptyPosition = position;
        moves++;
        
        document.getElementById('moves').textContent = moves;
        renderPuzzle();
        updateProgress();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        if (checkWin()) {
            endGame();
        }
    }
}

// –ü–æ–º–µ–Ω—è—Ç—å —Ñ–∏–≥—É—Ä—ã –º–µ—Å—Ç–∞–º–∏
function swapPieces(pos1, pos2) {
    const temp = puzzle[pos1];
    puzzle[pos1] = puzzle[pos2];
    puzzle[pos2] = temp;
}

// –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
function updateProgress() {
    let correctCount = 0;
    for (let i = 0; i < 8; i++) {
        if (puzzle[i] === i + 1) {
            correctCount++;
        }
    }
    
    const progress = Math.floor((correctCount / 8) * 100);
    document.getElementById('progress').textContent = progress + '%';
}

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–±–µ–¥—É
function checkWin() {
    for (let i = 0; i < 8; i++) {
        if (puzzle[i] !== i + 1) {
            return false;
        }
    }
    return puzzle[8] === 0;
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
function showMessage(text, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.className = 'message message-' + type;
    messageDiv.textContent = text;
    
    setTimeout(() => {
        messageDiv.className = '';
        messageDiv.textContent = '';
    }, 3000);
}

// –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä
function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('timer').textContent = minutes + ':' + seconds.toString().padStart(2, '0');
}

// –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É
function endGame() {
    gameActive = false;
    clearInterval(timerInterval);
    
    const totalTime = Math.floor((Date.now() - startTime) / 1000);
    const score = Math.max(1000 - moves * 10 - totalTime * 2, 100);
    const earnedCoins = Math.floor(score * {{ game.reward_coins }} / 1000);
    
    showMessage('üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω! –û—á–∫–∏: ' + score, 'success');
    
    document.getElementById('shuffle-btn').style.display = 'none';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('/games/play/{{ game.id }}/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: 'score=' + score + '&time_spent=' + totalTime
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', data);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', error);
    });
}

// –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä
function startTimer() {
    clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 1000);
}

// –ü–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    initPuzzle();
});
</script>
{% endblock %}
