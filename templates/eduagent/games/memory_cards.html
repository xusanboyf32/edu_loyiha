{% extends 'base.html' %}

{% block title %}{{ game.title }} - Falak{% endblock %}

{% block extra_css %}
<style>
.game-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.game-board {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.cards-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin: 20px 0;
}

.memory-card {
    aspect-ratio: 1;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    cursor: pointer;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.6s;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.memory-card:hover {
    transform: scale(1.05);
}

.memory-card.flipped {
    transform: rotateY(180deg);
}

.memory-card.matched {
    opacity: 0.6;
    cursor: not-allowed;
    transform: rotateY(180deg) scale(0.95);
}

.card-face {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: bold;
}

.card-front {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.card-back {
    background: white;
    color: #333;
    transform: rotateY(180deg);
    border: 2px solid #e0e0e0;
}

.game-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 30px;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.stat-number {
    font-size: 24px;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.game-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.btn-game {
    padding: 15px 30px;
    font-size: 18px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-start {
    background: #28a745;
    color: white;
}

.btn-restart {
    background: #ffc107;
    color: #333;
}

.message {
    padding: 15px;
    border-radius: 10px;
    margin: 20px 0;
    font-weight: bold;
    text-align: center;
}

.message-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.message-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="game-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã -->
        <div class="text-center mb-4">
            <h2><i class="fas fa-brain me-2"></i>{{ game.title }}</h2>
            <p class="text-muted">{{ game.description }}</p>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã -->
        <div class="game-stats">
            <div class="stat-item">
                <div class="stat-number" id="moves">0</div>
                <div class="stat-label">–•–æ–¥–æ–≤</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="timer">0:00</div>
                <div class="stat-label">–í—Ä–µ–º—è</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="coins">{{ user_coins }}</div>
                <div class="stat-label">–ú–æ–Ω–µ—Ç—ã</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="matches">0/8</div>
                <div class="stat-label">–ü–∞—Ä</div>
            </div>
        </div>

        <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
        <div class="game-board">
            <div class="cards-grid" id="cards-grid">
                <!-- –ö–∞—Ä—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            
            <div id="message"></div>
            
            <div class="game-controls">
                <button class="btn-game btn-start" id="start-btn" onclick="startGame()">
                    <i class="fas fa-play me-2"></i>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É
                </button>
                <button class="btn-game btn-restart" id="restart-btn" onclick="restartGame()" style="display: none;">
                    <i class="fas fa-redo me-2"></i>–ù–æ–≤–∞—è –∏–≥—Ä–∞
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let cards = [];
let flippedCards = [];
let matchedPairs = 0;
let moves = 0;
let startTime = Date.now();
let timerInterval;
let gameActive = false;

// –≠–º–æ–¥–∑–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
const cardSymbols = ['üéà', 'üé®', 'üé≠', 'üé™', 'üéØ', 'üé≤', 'üé∏', 'üé∫'];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
function initGame() {
    createCards();
    renderCards();
}

// –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏
function createCards() {
    cards = [];
    cardSymbols.forEach((symbol, index) => {
        cards.push({ id: index * 2, symbol: symbol, matched: false });
        cards.push({ id: index * 2 + 1, symbol: symbol, matched: false });
    });
    
    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
    cards.sort(() => Math.random() - 0.5);
}

// –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏
function renderCards() {
    const grid = document.getElementById('cards-grid');
    grid.innerHTML = '';
    
    cards.forEach((card, index) => {
        const cardElement = document.createElement('div');
        cardElement.className = 'memory-card';
        cardElement.dataset.index = index;
        cardElement.dataset.symbol = card.symbol;
        cardElement.onclick = () => flipCard(index);
        
        cardElement.innerHTML = `
            <div class="card-face card-front">?</div>
            <div class="card-face card-back">${card.symbol}</div>
        `;
        
        grid.appendChild(cardElement);
    });
}

// –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
function startGame() {
    gameActive = true;
    moves = 0;
    matchedPairs = 0;
    flippedCards = [];
    startTime = Date.now();
    
    document.getElementById('moves').textContent = '0';
    document.getElementById('matches').textContent = '0/8';
    document.getElementById('start-btn').style.display = 'none';
    document.getElementById('restart-btn').style.display = 'inline-block';
    document.getElementById('message').innerHTML = '';
    
    initGame();
    startTimer();
}

// –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É
function restartGame() {
    gameActive = false;
    clearInterval(timerInterval);
    startGame();
}

// –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
function flipCard(index) {
    if (!gameActive) return;
    
    const card = cards[index];
    const cardElement = document.querySelector('[data-index="' + index + '"]');
    
    // –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å —É–∂–µ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—ã–µ –∏–ª–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    if (card.matched || flippedCards.includes(index)) return;
    
    // –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
    cardElement.classList.add('flipped');
    flippedCards.push(index);
    
    // –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—ã –¥–≤–µ –∫–∞—Ä—Ç–æ—á–∫–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    if (flippedCards.length === 2) {
        moves++;
        document.getElementById('moves').textContent = moves;
        
        setTimeout(() => checkMatch(), 1000);
    }
}

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
function checkMatch() {
    const [index1, index2] = flippedCards;
    const card1 = cards[index1];
    const card2 = cards[index2];
    
    if (card1.symbol === card2.symbol) {
        // –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ
        card1.matched = true;
        card2.matched = true;
        matchedPairs++;
        
        document.getElementById('matches').textContent = matchedPairs + '/8';
        
        const cardElement1 = document.querySelector('[data-index="' + index1 + '"]');
        const cardElement2 = document.querySelector('[data-index="' + index2 + '"]');
        
        cardElement1.classList.add('matched');
        cardElement2.classList.add('matched');
        
        showMessage('–ù–∞–π–¥–µ–Ω–∞ –ø–∞—Ä–∞! üéâ', 'success');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
        if (matchedPairs === 8) {
            endGame();
        }
    } else {
        // –ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        const cardElement1 = document.querySelector('[data-index="' + index1 + '"]');
        const cardElement2 = document.querySelector('[data-index="' + index2 + '"]');
        
        cardElement1.classList.remove('flipped');
        cardElement2.classList.remove('flipped');
    }
    
    flippedCards = [];
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
function showMessage(text, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.className = 'message message-' + type;
    messageDiv.textContent = text;
    
    setTimeout(() => {
        messageDiv.className = '';
        messageDiv.textContent = '';
    }, 2000);
}

// –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä
function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('timer').textContent = minutes + ':' + seconds.toString().padStart(2, '0');
}

// –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É
function endGame() {
    gameActive = false;
    clearInterval(timerInterval);
    
    const totalTime = Math.floor((Date.now() - startTime) / 1000);
    const score = Math.max(100 - moves * 2, 10);
    const earnedCoins = Math.floor(score * {{ game.reward_coins }} / 100);
    
    showMessage('üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û—á–∫–∏: ' + score, 'success');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('/games/play/{{ game.id }}/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: 'score=' + score + '&time_spent=' + totalTime
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', data);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', error);
    });
}

// –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä
function startTimer() {
    clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 1000);
}

// –ü–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    initGame();
});
</script>
{% endblock %}
